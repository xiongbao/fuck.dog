var pages=2;jQuery(document).ready(function(o){o("#admin-img-file").change(function(){var e=o(".admin-upload-img label");e.text("上传中...");var a=this.files.length,n=0,s=o("#background,#progressBar");s&&s.show();for(var t=0;t<a;t++){var i=this.files[t],l=new FormData;l.append("smfile",i),o.ajax({url:smms_url+"/action/multi-upload?do=upload",type:"POST",processData:!1,contentType:!1,data:l,dataType:"json",success:function(t){t.data&&t.data.url&&(n++,o('textarea[name="content"]').insertAtCaret('<img class="aligncenter" src="'+t.data.url+'" />'),o("html").find("iframe").contents().find("body").append('<img class="aligncenter" src="'+t.data.url+'" />'),n===a&&(alert("上传成功！"),e.text("上传"),location.reload()))},error:function(t){e.text("上传"),s.hide()}})}}),o("#toggleModal").click(function(){pages=2,o("#img_list > li").remove(),o.ajax({url:smms_url+"/action/multi-upload?do=list",type:"GET",cache:!1,dataType:"json",success:function(t){for(var e in t)o("#img_list").append('<li><img id="modal-image-'+e+'" class="modal-image" src="'+t[e].url+'" /></li>');t.length<10?o("#upload-btn").css("display","none"):o("#upload-btn").css("display","inline-block")}})}),o("#upload-btn").click(function(){o.ajax({url:smms_url+"/action/multi-upload?do=list",type:"GET",cache:!1,dataType:"json",data:{pages:pages},success:function(t){if(0!==t.length){for(var e in t)o("#img_list").append('<li><img id="modal-image-'+e+'" class="modal-image" src="'+t[e].url+'" /></li>');pages++}else o("#upload-btn").css("display","none"),alert("已加载完全部图片")}})}),o(document).mouseup(function(t){var e=o(".modal");e.is(t.target)||0!==e.has(t.target).length||o(".modal").css("display","none")}),o("#img_list").on("click","img",function(t){o('textarea[name="text"]').insertAtCaret('<img class="aligncenter" src="'+t.target.src+'" />'),o("html").find("iframe").contents().find("body").append('<img class="aligncenter" src="'+t.target.src+'" />')}),o.fn.extend({insertAtCaret:function(t){var e,a,n,s=o(this)[0];s&&(document.selection?(this.focus(),sel=document.selection.createRange(),sel.text=t,this.focus()):"selectionStart"in s||s.selectionStart||"0"===s.selectionStart?(e=s.selectionStart,a=s.selectionEnd,n=s.scrollTop,s.value=s.value.substring(0,e)+t+s.value.substring(a,s.value.length),this.focus(),s.selectionStart=e+t.length,s.selectionEnd=e+t.length,s.scrollTop=n):(this.value+=t,this.focus()))}})});